---
// src/components/InventoryCard.astro
interface Props {
  id: string;
  name: string;
  category: "bulb" | "battery" | "ink";
  type: string;
  shape?: string;
  location?: string;
  building?: string;
  department?: string;
  detail?: string;
  quantity?: number;
  requiredCount: number;
  notes?: string;
  inStockCount: number;
  colorTemp?: string;
  dimmable?: string | boolean;
  rechargeable?: string | boolean;
  lastReplaced?: string;
  stockMap?: Record<string, number>;
}

const { 
  id, name, category, type, shape, location, 
  building, department, detail, quantity,
  requiredCount, notes, inStockCount, colorTemp,
  dimmable, rechargeable, lastReplaced, stockMap
} = Astro.props;

const isRechargeable = rechargeable === true || rechargeable === "true";
const isDimmable = dimmable === true || dimmable === "true";

const isPrinter = category === "ink";
const cartridges = isPrinter && shape ? shape.split(",").map(c => c.trim()) : [];

const cartridgeStocks = isPrinter && stockMap 
  ? cartridges.map(cartridge => ({
      name: cartridge,
      count: stockMap[`${type}-${cartridge}-false-false`] || 0
    }))
  : [];

const itemQuantity = quantity || 1;
const totalRequired = requiredCount * itemQuantity;
const isOutOfStock = !isRechargeable && !isPrinter && (inStockCount < totalRequired);
const isPartiallyInStock = !isOutOfStock && inStockCount < (totalRequired * 2) && !isRechargeable; // Tips om lav beholdning

const locationDisplay = building || department || detail
  ? [building, department, detail].filter(Boolean).join(" / ")
  : location;

const formatDate = (dateStr?: string) => {
  if (!dateStr) return null;
  const date = new Date(dateStr);
  const now = new Date();
  const diffDays = Math.floor((now.getTime() - date.getTime()) / (1000 * 60 * 60 * 24));
  
  if (diffDays === 0) return "I dag";
  if (diffDays === 1) return "I g√•r";
  if (diffDays < 7) return `${diffDays} dager siden`;
  if (diffDays < 30) {
    const weeks = Math.floor(diffDays / 7);
    return weeks === 1 ? "1 uke siden" : `${weeks} uker siden`;
  }
  if (diffDays < 365) {
    const months = Math.floor(diffDays / 30);
    return months === 1 ? "1 m√•ned siden" : `${months} m√•neder siden`;
  }
  const years = Math.floor(diffDays / 365);
  return years === 1 ? "1 √•r siden" : `${years} √•r siden`;
};
---

<div class={`group relative p-6 rounded-[2.5rem] border-2 transition-all duration-300 ${
  isOutOfStock 
    ? 'border-red-200 bg-red-50/50 shadow-sm' 
    : isRechargeable 
      ? 'border-emerald-100 bg-emerald-50/30' 
      : 'border-slate-100 bg-white shadow-sm hover:shadow-md'
}`}>
  
  <div class="flex justify-between items-center mb-4 gap-3">
    <div class="flex items-center gap-2">
      {itemQuantity > 1 && (
        <div class="bg-blue-500 text-white text-[10px] font-black px-2.5 py-1 rounded-full shadow-sm uppercase tracking-wider">
          {itemQuantity} enheter
        </div>
      )}
      {!isRechargeable && !isPrinter && (
        <div class={`px-2.5 py-1 rounded-xl text-[10px] font-black uppercase tracking-tighter border-2 ${
          isOutOfStock 
            ? 'bg-red-500 border-red-500 text-white animate-pulse' 
            : isPartiallyInStock
              ? 'bg-orange-400 border-orange-400 text-white'
              : 'bg-white border-slate-100 text-slate-600'
        }`}>
          Lager: {inStockCount}/{totalRequired}
        </div>
      )}
    </div>
    
    <div class="flex items-center gap-2">
      <button 
        type="button"
        onclick={`window.location.href='/enheter?edit=${id}'`}
        class="w-8 h-8 rounded-full bg-blue-50 hover:bg-blue-500 text-blue-600 hover:text-white transition-all duration-200 flex items-center justify-center shadow-sm"
        title={`Rediger ${name}`}
      >
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/>
        </svg>
      </button>
      
      <form method="POST" id={`delete-form-${id}`} class="inline-block">
        <input type="hidden" name="action" value="delete_item" />
        <input type="hidden" name="itemId" value={id} />
        <button 
          type="submit"
          class="w-8 h-8 rounded-full bg-red-50 hover:bg-red-500 text-red-600 hover:text-white transition-all duration-200 flex items-center justify-center shadow-sm"
          title={`Slett ${name}`}
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
          </svg>
        </button>
      </form>
    </div>
  </div>
  
  <div class="mb-4">
    <div class="flex items-center gap-2 mb-1">
      <span class={`w-2 h-2 rounded-full ${isOutOfStock ? 'bg-red-400' : 'bg-emerald-400'}`}></span>
      <p class="text-[10px] font-black uppercase tracking-[0.15em] text-slate-400">
        {locationDisplay || 'Lokasjon ikke oppgitt'}
      </p>
    </div>
    <h3 class="text-xl font-black text-slate-900 leading-tight tracking-tight">
      {name}
    </h3>
  </div>

  <div class="flex flex-wrap gap-2 mb-5">
    <span class="bg-slate-900 text-white text-[10px] font-black px-3 py-1.5 rounded-xl uppercase shadow-sm">
      {type}
    </span>

    {isPrinter && colorTemp && (
      <span class="bg-purple-100 text-purple-700 text-[10px] font-black px-3 py-1.5 rounded-xl uppercase border border-purple-200/50">
        üñ®Ô∏è {colorTemp}
      </span>
    )}

    {isPrinter && cartridgeStocks.length > 0 && (
      <div class="flex flex-wrap gap-1.5">
        {cartridgeStocks.map((item) => (
          <span class={`text-[10px] font-black px-2.5 py-1.5 rounded-xl uppercase border ${
            item.count > 0 
              ? 'bg-emerald-100 text-emerald-700 border-emerald-200/50' 
              : 'bg-red-100 text-red-700 border-red-200/50'
          }`}>
            {item.name} ({item.count})
          </span>
        ))}
      </div>
    )}

    {shape && !isRechargeable && !isPrinter && (
      <span class="bg-indigo-100 text-indigo-700 text-[10px] font-black px-3 py-1.5 rounded-xl uppercase border border-indigo-200/50">
        üì¶ {shape}
      </span>
    )}

    {isDimmable && (
      <span class="bg-amber-100 text-amber-800 text-[10px] font-black px-3 py-1.5 rounded-xl uppercase border border-amber-200">
        üîÜ Dimbar
      </span>
    )}

    {colorTemp && !isPrinter && (
      <span class="bg-slate-100 text-slate-600 text-[10px] font-black px-3 py-1.5 rounded-xl uppercase">
        üå°Ô∏è {colorTemp}
      </span>
    )}

    {isRechargeable && (
      <span class="bg-emerald-100 text-emerald-800 text-[10px] font-black px-3 py-1.5 rounded-xl uppercase border border-emerald-200">
        üîå Oppladbar
      </span>
    )}
  </div>

  {/* Merknadsfelt */}
  {notes && (
    <div class="mb-6 p-4 bg-slate-50/80 border border-slate-100 rounded-2xl relative">
      <div class="text-slate-400 absolute -top-2 -left-1 bg-white px-2 italic text-[10px] font-bold uppercase tracking-wider">Notat</div>
      <p class="text-sm text-slate-600 leading-relaxed italic">"{notes}"</p>
    </div>
  )}

  {/* Sist vedlikeholdt */}
  {lastReplaced && (
    <div class="mb-4 flex items-center gap-2 px-2">
      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-400"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
      <span class="text-xs text-slate-500 font-bold uppercase tracking-tight">Sist byttet: {formatDate(lastReplaced)}</span>
    </div>
  )}

  <form method="POST" action="" id={`form-${id}`}>
    <input type="hidden" name="action" value="replace_item" />
    <input type="hidden" name="itemId" value={id} />
    
    {/* Printer-velger */}
    {isPrinter && cartridges.length > 0 && (
      <div class="mb-4 p-4 bg-purple-50/50 border-2 border-purple-100 rounded-2xl">
        <label class="block text-[9px] font-black uppercase text-purple-700 mb-3 ml-2">
          üñ®Ô∏è Hvilke patroner bytter du n√•?
        </label>
        <div class="grid grid-cols-2 gap-2">
          {cartridges.map((cartridge) => (
            <label class="flex items-center gap-2 bg-white px-3 py-2.5 rounded-xl border-2 border-purple-100 cursor-pointer hover:border-purple-300 transition-colors">
              <input 
                type="checkbox" 
                name="cartridges" 
                value={cartridge}
                class="w-4 h-4 text-purple-600 rounded border-purple-300 focus:ring-purple-500"
              />
              <span class="text-xs font-bold text-slate-700">{cartridge}</span>
            </label>
          ))}
        </div>
      </div>
    )}
    
    {/* Antall-velger for p√¶rer/batterier */}
    {!isPrinter && !isRechargeable && requiredCount > 1 && (
      <div class="mb-3">
        <label class="block text-[9px] font-black uppercase text-slate-500 mb-2 ml-2">
          {category === "bulb" ? "üí° Antall p√¶rer som byttes" : "üîã Antall batterier som byttes"}
          <span class="text-indigo-400 ml-1">(av {requiredCount} totalt)</span>
        </label>
        <input 
          type="number" 
          name="bulbCount" 
          min="1" 
          max={requiredCount}
          value={requiredCount}
          class="w-full bg-white border-2 border-slate-200 rounded-xl px-4 py-2.5 text-slate-900 font-bold outline-none focus:border-indigo-400"
        />
      </div>
    )}
    
    {/* Multi-enhet velger */}
    {itemQuantity > 1 && !isRechargeable && !isPrinter && (
      <div class="mb-3">
        <label class="block text-[9px] font-black uppercase text-slate-500 mb-2 ml-2">
         Antall enheter √• utf√∏re bytte p√•
         <span class="text-indigo-400 ml-1">(av {itemQuantity})</span>
        </label>
        <input 
          type="number" 
          name="replaceQuantity" 
          min="1" 
          max={itemQuantity}
          value="1"
          class="w-full bg-white border-2 border-slate-200 rounded-xl px-4 py-2.5 text-slate-900 font-bold outline-none focus:border-indigo-400"
        />
      </div>
    )}
    
    <div class="flex gap-2">
      <button 
        type="submit"
        class={`flex-[4] font-black py-4 rounded-[1.5rem] transition-all duration-200 flex items-center justify-center gap-2 active:scale-[0.97] ${
          isPrinter 
            ? 'bg-purple-600 hover:bg-purple-500 text-white shadow-lg' 
            : isRechargeable 
              ? 'bg-emerald-600 hover:bg-emerald-500 text-white shadow-lg' 
              : isOutOfStock 
                ? 'bg-orange-500 hover:bg-orange-600 text-white shadow-lg' 
                : 'bg-indigo-600 hover:bg-indigo-500 text-white shadow-lg'
        }`}
      >
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 16h5v5"/>
        </svg>
        {isRechargeable ? 'LADET' : 'BYTT'}
      </button>

      {!isPrinter && !isRechargeable && (
        <a 
          href="/beholdning"
          class="flex-[1.2] font-black py-4 rounded-[1.5rem] transition-all duration-200 flex flex-col items-center justify-center gap-0.5 active:scale-[0.97] bg-red-500 hover:bg-red-600 text-white shadow-lg"
          title="Se handleliste"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/>
          </svg>
          <span class="text-[9px] leading-none uppercase">Behov</span>
        </a>
      )}
    </div>
  </form>
</div>