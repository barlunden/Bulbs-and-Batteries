---
export const prerender = false;
import Layout from "../layouts/Layout.astro";
import { supabase, createAuthenticatedClient } from "../lib/supabase";

const { householdId, user } = Astro.locals;

const accessToken = Astro.cookies.get("sb-access-token")?.value;
const authedSupabase = accessToken
  ? createAuthenticatedClient(accessToken)
  : supabase;

let successMessage: string | null = null;
let errorMessage: string | null = null;

// H√•ndter POST-requests
if (Astro.request.method === "POST") {
  const data = await Astro.request.formData();
  const action = data.get("action");

  if (action === "make_me_admin") {
    // Bruk global supabase-klient for √• omg√• RLS n√•r vi legger til f√∏rste admin
    const { data: updateData, error: updateError } = await supabase
      .from("household_members")
      .update({ role: "admin" })
      .eq("household_id", householdId)
      .eq("user_id", user?.id)
      .select();

    if (updateError) {
      errorMessage = `Kunne ikke oppdatere rolle: ${updateError.message}`;
    } else if (!updateData || updateData.length === 0) {
      // Hvis det ikke finnes noen rad √• oppdatere, legg til ny
      const { data: insertData, error: insertError } = await supabase
        .from("household_members")
        .insert([
          {
            household_id: householdId,
            user_id: user?.id,
            role: "admin",
          },
        ])
        .select();

      if (insertError) {
        errorMessage = `Kunne ikke legge deg til: ${insertError.message}`;
      } else {
        successMessage = "Du er n√• administrator for denne husstanden!";
        return Astro.redirect("/husstand");
      }
    } else {
      successMessage = "Du er n√• administrator for denne husstanden!";
      return Astro.redirect("/husstand");
    }
  }

  if (action === "invite") {
    const email = data.get("email")?.toString().toLowerCase().trim();
    const role = data.get("role")?.toString() || "member";

    if (email) {
      // Finn bruker-ID basert p√• e-post fra auth.users via RPC eller profiles
      const { data: profile } = await supabase
        .from("profiles")
        .select("id, email")
        .eq("email", email)
        .single();

      if (!profile) {
        // Pr√∏v √• finne bruker direkte i auth.users og opprett profil
        // Dette er en fallback hvis triggeren feilet
        errorMessage = `Fant ingen bruker med e-post ${email}. Personen m√• registrere seg f√∏rst.`;
      } else {
        // Sjekk om bruker allerede er medlem
        const { data: existing } = await supabase
          .from("household_members")
          .select("id")
          .eq("household_id", householdId)
          .eq("user_id", profile.id)
          .single();

        if (existing) {
          errorMessage = "Denne brukeren er allerede medlem av husstanden";
        } else {
          // Legg til som medlem
          const { error } = await supabase.from("household_members").insert([
            {
              household_id: householdId,
              user_id: profile.id,
              role: role,
            },
          ]);

          if (error) {
            errorMessage = `Kunne ikke legge til medlem: ${error.message}`;
          } else {
            successMessage = `${email} er n√• lagt til i husstanden!`;
          }
        }
      }
    }
  }

  if (action === "remove") {
    const memberId = data.get("memberId")?.toString();

    if (memberId) {
      const { error } = await authedSupabase
        .from("household_members")
        .delete()
        .eq("id", memberId)
        .eq("household_id", householdId); // Sikkerhet: kun fjern fra eget hus

      if (error) {
        errorMessage = `Kunne ikke fjerne medlem: ${error.message}`;
      } else {
        successMessage = "Medlem fjernet fra husstanden";
      }
    }
  }

  if (action === "change_role") {
    const memberId = data.get("memberId")?.toString();
    const newRole = data.get("newRole")?.toString();

    if (memberId && newRole) {
      const { error } = await authedSupabase
        .from("household_members")
        .update({ role: newRole })
        .eq("id", memberId)
        .eq("household_id", householdId);

      if (error) {
        errorMessage = `Kunne ikke endre rolle: ${error.message}`;
      } else {
        successMessage = "Rolle oppdatert";
      }
    }
  }
}

// Hent husstandsinfo
const { data: household } = await supabase
  .from("households")
  .select("name")
  .eq("id", householdId)
  .single();

// Hent alle medlemmer
const { data: members, error: membersError } = await supabase
  .from("household_members")
  .select("*")
  .eq("household_id", householdId);

// Hent profiler for alle medlemmer
let membersWithProfiles = [];
if (members && members.length > 0) {
  const userIds = members.map((m) => m.user_id);
  const { data: profiles } = await supabase
    .from("profiles")
    .select("id, email")
    .in("id", userIds);

  // Kombiner members med profiles
  membersWithProfiles = members.map((member) => ({
    ...member,
    profiles: profiles?.find((p) => p.id === member.user_id),
  }));
}

// Sjekk om n√•v√¶rende bruker er admin
const currentUserMember = membersWithProfiles?.find(
  (m) => m.user_id === user?.id,
);
const isAdmin = currentUserMember?.role === "admin";
---

<Layout title="Administrer Team">
  <main class="max-w-md mx-auto px-6 pt-10 pb-32">
    <header class="mb-8">
      <div class="flex items-center gap-2 mb-2">
        <span class="text-indigo-500 text-lg">üìç</span>
        <h1 class="text-3xl font-black text-slate-900 tracking-tighter">
          {household?.name}
        </h1>
      </div>
      <p class="text-slate-500 text-sm font-medium italic px-1">
        Administrer hvem som har tilgang til dette stedet.
      </p>

      {/* KRITISK VARSEL: IKKE ADMIN */}
      {
        (!currentUserMember || currentUserMember.role !== "admin") && (
          <div class="mt-6 p-6 bg-orange-50 border-2 border-orange-200 rounded-[2rem] shadow-sm">
            <div class="flex items-center gap-2 mb-2">
              <span class="text-orange-600 font-black text-xl">‚ö†Ô∏è</span>
              <p class="font-black text-orange-900 text-sm uppercase tracking-tight">
                Begrenset tilgang
              </p>
            </div>
            <p class="text-sm text-orange-800 mb-4 leading-relaxed font-medium">
              {!currentUserMember
                ? "Du er ikke registrert som medlem av dette teamet enn√•."
                : `Du er registrert som medlem, men du har ikke administrator-rettigheter.`}
            </p>
            <form method="POST">
              <input type="hidden" name="action" value="make_me_admin" />
              <button
                type="submit"
                class="w-full bg-orange-600 text-white font-black py-4 rounded-2xl hover:bg-orange-700 transition-all shadow-lg shadow-orange-200 uppercase tracking-widest text-[10px]"
              >
                Bli administrator n√•
              </button>
            </form>
          </div>
        )
      }
    </header>

    {/* FEEDBACK MELDINGER */}
    {
      successMessage && (
        <div class="bg-emerald-50 border-2 border-emerald-100 p-4 rounded-2xl mb-6 animate-in fade-in slide-in-from-top-2">
          <p class="text-emerald-800 font-black text-xs uppercase tracking-tight flex items-center gap-2">
            <span>‚úÖ</span> {successMessage}
          </p>
        </div>
      )
    }

    {
      errorMessage && (
        <div class="bg-red-50 border-2 border-red-100 p-4 rounded-2xl mb-6 animate-in fade-in">
          <p class="text-red-800 font-black text-xs uppercase tracking-tight flex items-center gap-2">
            <span>‚ö†Ô∏è</span> {errorMessage}
          </p>
        </div>
      )
    }

    {/* INVITASJONSKORT */}
    {
      isAdmin && (
        <section class="bg-slate-900 p-8 rounded-[2.5rem] shadow-2xl text-white mb-10 relative overflow-hidden">
          <div class="absolute -right-6 -top-6 w-24 h-24 bg-indigo-500/20 rounded-full blur-2xl" />

          <div class="flex items-center gap-3 mb-6 relative z-10">
            <div class="bg-indigo-500 text-white p-2 rounded-xl">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="3"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <>
                  <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
                  <circle cx="9" cy="7" r="4" />
                  <path d="M22 21v-2a4 4 0 0 0-3-3.87" />
                </>
              </svg>
            </div>
            <h2 class="font-black uppercase tracking-widest text-[10px] text-indigo-300">
              Legg til medlem
            </h2>
          </div>

          <form method="POST" class="space-y-4 relative z-10">
            <input type="hidden" name="action" value="invite" />{" "}
            <div>
              <label class="block text-[9px] font-black uppercase text-slate-500 mb-2 ml-2 tracking-widest">
                E-postadresse
              </label>
              <input
                type="email"
                name="email"
                required
                placeholder="navn@eksempel.no"
                class="w-full bg-slate-800 border-2 border-slate-700 rounded-2xl px-5 py-4 text-white font-bold outline-none focus:border-indigo-500 transition-all placeholder:text-slate-600"
              />
              <p class="text-[9px] text-indigo-300/60 mt-2 ml-2 italic leading-tight">
                Viktig: Brukeren m√• ha registrert sin egen konto f√∏r du kan
                legge dem til her.
              </p>
            </div>
            <button
              type="submit"
              class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-black py-5 rounded-[1.5rem] shadow-xl shadow-indigo-900/40 transition-all active:scale-95 uppercase tracking-widest text-[10px]"
            >
              Legg til i teamet
            </button>
          </form>
        </section>
      )
    }

    {/* MEDLEMSLISTE */}
    <section>
      <div class="flex items-center justify-between mb-6 px-2">
        <h2
          class="text-[10px] font-black uppercase tracking-[0.2em] text-slate-300"
        >
          Medlemmer i teamet
        </h2>
        <span
          class="bg-slate-100 text-slate-500 px-2.5 py-1 rounded-lg text-[9px] font-black uppercase"
          >{members?.length || 0} totalt</span
        >
      </div>

      <div class="space-y-3">
        {
          membersWithProfiles && membersWithProfiles.length > 0 ? (
            membersWithProfiles.map((member: any) => (
              <div class="bg-white border-2 border-slate-100 rounded-[2.2rem] p-6 shadow-sm group hover:border-indigo-100 transition-all">
                <div class="flex justify-between items-center">
                  <div class="flex-1">
                    <div class="flex items-center gap-2 mb-1">
                      <h3 class="font-black text-slate-900 text-sm tracking-tight truncate max-w-[150px]">
                        {member.profiles?.email || "Ukjent bruker"}
                      </h3>
                      {member.user_id === user?.id && (
                        <span class="text-[8px] font-black bg-emerald-100 text-emerald-700 px-2 py-0.5 rounded-full uppercase">
                          Deg
                        </span>
                      )}
                    </div>
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">
                      {member.role === "admin" ? "‚≠ê Admin" : "üë§ Medlem"}
                    </p>
                  </div>

                  {isAdmin && member.user_id !== user?.id && (
                    <div class="flex gap-2">
                      <form method="POST">
                        <input
                          type="hidden"
                          name="action"
                          value="change_role"
                        />
                        <input
                          type="hidden"
                          name="memberId"
                          value={member.id}
                        />
                        <input
                          type="hidden"
                          name="newRole"
                          value={member.role === "admin" ? "member" : "admin"}
                        />
                        <button
                          type="submit"
                          class="bg-slate-50 hover:bg-indigo-50 text-slate-400 hover:text-indigo-600 p-3 rounded-xl transition-all"
                          title="Endre rolle"
                        >
                          <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="16"
                            height="16"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="3"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                          >
                            <path d="m16 10 4 4-4 4" />
                            <path d="m8 14-4-4 4-4" />
                            <path d="M12 2v20" />
                          </svg>
                        </button>
                      </form>

                      <form method="POST">
                        <input type="hidden" name="action" value="remove" />
                        <input
                          type="hidden"
                          name="memberId"
                          value={member.id}
                        />
                        <button
                          type="submit"
                          onclick="return confirm('Er du sikker p√• at du vil fjerne dette medlemmet fra teamet?')"
                          class="bg-red-50 hover:bg-red-500 text-red-400 hover:text-white p-3 rounded-xl transition-all"
                          title="Fjern medlem"
                        >
                          <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="16"
                            height="16"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="3"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                          >
                            <path d="M3 6h18" />
                            <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" />
                          </svg>
                        </button>
                      </form>
                    </div>
                  )}
                </div>
              </div>
            ))
          ) : (
            <div class="bg-slate-50 border-2 border-dashed border-slate-100 rounded-[2.5rem] p-12 text-center">
              <p class="text-slate-400 font-black text-xs uppercase tracking-widest">
                Ingen medlemmer
              </p>
            </div>
          )
        }
      </div>
    </section>
  </main>
</Layout>
