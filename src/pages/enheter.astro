---
export const prerender = false;
import Layout from "../layouts/Layout.astro";
import InventoryCard from "../components/InventoryCard.astro";
import { supabase, createAuthenticatedClient } from "../lib/supabase";
import type { InventoryItem, StockItem } from "../types/inventory";

const { householdId } = Astro.locals;

// 1. SETUP & AUTENTISERING
const accessToken = Astro.cookies.get("sb-access-token")?.value;
const authedSupabase = accessToken
  ? createAuthenticatedClient(accessToken)
  : supabase;

const { data: household } = await authedSupabase
  .from("households")
  .select("type, name")
  .eq("id", householdId)
  .single();

const householdType = household?.type || "home";
const householdName = household?.name || "stedet";

const url = new URL(Astro.request.url);
const searchQuery = url.searchParams.get("search") || "";
const categoryFilter = url.searchParams.get("category") || "all";
const typeFilter = url.searchParams.get("type") || "";
const buildingFilter = url.searchParams.get("building") || "";
const editId = url.searchParams.get("edit") || null;

const advancedParam = url.searchParams.get("advanced");
const advancedMode =
  advancedParam !== null
    ? advancedParam === "true"
    : householdType === "facility";

// 2. ACTION HÃ…NDTERING (Sletting, Oppdatering, Bytte, Opprettelse)
if (Astro.request.method === "POST") {
  try {
    const data = await Astro.request.formData();
    const action = data.get("action");

    if (action === "delete_item") {
      const itemId = data.get("itemId")?.toString();
      const itemName = data.get("itemName")?.toString() || "Utstyr";
      await authedSupabase
        .from("items")
        .delete()
        .eq("id", itemId)
        .eq("household_id", householdId);
      return Astro.redirect(
        Astro.url.pathname +
          `?toast=deleted&item=${encodeURIComponent(itemName)}`,
      );
    }

    if (action === "update_item") {
      const itemId = data.get("itemId")?.toString();
      const category = data.get("category")?.toString();
      const updates: any = {
        name: data.get("name")?.toString(),
        type: data.get("type")?.toString().toUpperCase(),
        required_count: Number(data.get("requiredCount") || 1),
        quantity: Number(data.get("quantity") || 1),
        building: data.get("building")?.toString() || null,
        department: data.get("department")?.toString() || null,
        detail: data.get("detail")?.toString() || null,
        notes: data.get("notes")?.toString() || null,
      };

      if (category === "bulb") {
        updates.shape = data.get("shape")?.toString() || null;
        updates.color_temp = data.get("colorTemp")?.toString() || null;
        updates.dimmable = data.get("dimmable") === "true";
      } else if (category === "battery") {
        updates.rechargeable = data.get("rechargeable") === "true";
      } else if (category === "ink") {
        const cartridgesRaw = data.get("cartridges")?.toString() || "";
        updates.shape = cartridgesRaw
          .split(/[\n,]+/)
          .map((c) => c.trim())
          .filter((c) => c.length > 0)
          .join(",");
        updates.color_temp = data.get("model")?.toString() || null;
      }

      await authedSupabase
        .from("items")
        .update(updates)
        .eq("id", itemId)
        .eq("household_id", householdId);
      return Astro.redirect(
        Astro.url.pathname +
          `?toast=updated&item=${encodeURIComponent(updates.name)}`,
      );
    }

    if (action === "replace_item") {
      const itemId = data.get("itemId")?.toString();
      const itemName = data.get("itemName")?.toString() || "Utstyr";
      const type = data.get("itemType")?.toString();
      const shape = data.get("itemShape")?.toString() || "";
      const category = data.get("itemCategory")?.toString();
      const replaceQuantity = Number(data.get("replaceQuantity") || 1);
      const dimmable = data.get("dimmable") === "true";
      const rechargeable = data.get("rechargeable") === "true";

      await authedSupabase
        .from("items")
        .update({ last_replaced: new Date().toISOString() })
        .eq("id", itemId)
        .eq("household_id", householdId);

      if (category === "ink") {
        const selectedCartridges = data.getAll("cartridges");
        for (const cartridge of selectedCartridges) {
          const { data: stock } = await authedSupabase
            .from("stock")
            .select("id, current_count")
            .eq("household_id", householdId)
            .eq("type", type)
            .eq("shape", cartridge)
            .eq("dimmable", false)
            .eq("rechargeable", false)
            .single();
          
          if (stock) {
            await authedSupabase
              .from("stock")
              .update({ current_count: Math.max(0, stock.current_count - 1) })
              .eq("id", stock.id);
          }
        }
      } else {
        const bulbCount = Number(data.get("bulbCount") || 1);
        const totalToReduce = bulbCount * replaceQuantity;
        
        // SÃ¸k fÃ¸rst etter eksakt match
        let query = authedSupabase
          .from("stock")
          .select("id, current_count, dimmable, rechargeable")
          .eq("household_id", householdId)
          .eq("type", type)
          .eq("dimmable", dimmable)
          .eq("rechargeable", rechargeable);

        if (shape && shape !== "null" && shape !== "") {
          query = query.eq("shape", shape);
        } else {
          query = query.or('shape.is.null,shape.eq.""');
        }

        let { data: stock, error: stockError } = await query.single();
        
        // Viss ingen eksakt match, sÃ¸k utan dimmable/rechargeable
        if (!stock || stockError) {
          let fallbackQuery = authedSupabase
            .from("stock")
            .select("id, current_count, dimmable, rechargeable")
            .eq("household_id", householdId)
            .eq("type", type);
            
          if (shape && shape !== "null" && shape !== "") {
            fallbackQuery = fallbackQuery.eq("shape", shape);
          } else {
            fallbackQuery = fallbackQuery.or('shape.is.null,shape.eq.""');
          }
          
          const { data: fallbackStock } = await fallbackQuery.single();
          
          if (fallbackStock) {
            stock = fallbackStock;
            // Oppdater stock til Ã¥ matche item
            await authedSupabase.from("stock")
              .update({ 
                dimmable: dimmable,
                rechargeable: rechargeable
              })
              .eq("id", stock.id);
          }
        }

        if (stock) {
          const newCount = Math.max(0, (stock.current_count || 0) - totalToReduce);
          await authedSupabase.from("stock")
            .update({ current_count: newCount })
            .eq("id", stock.id);
        }
      }
      
      return Astro.redirect(
        Astro.url.pathname +
          `?toast=replaced&item=${encodeURIComponent(itemName)}`,
      );
    }

    if (action === "create") {
      const category = data.get("category")?.toString();
      const name = data.get("name")?.toString();
      const type = data.get("type")?.toString().toUpperCase();

      const baseItem: any = {
        name,
        category,
        type,
        building: data.get("building"),
        department: data.get("department"),
        detail: data.get("detail"),
        quantity: Number(data.get("quantity") || 1),
        notes: data.get("notes"),
        household_id: householdId,
      };

      if (category === "ink") {
        const cartridges = (data.get("cartridges")?.toString() || "")
          .split(/[\n,]+/)
          .map((c) => c.trim())
          .filter((c) => c.length > 0);
        baseItem.shape = cartridges.join(",");
        baseItem.required_count = cartridges.length;
        baseItem.color_temp = data.get("model");
      } else {
        baseItem.required_count = Number(data.get("requiredCount") || 1);
        baseItem.shape = data.get("shape");
        baseItem.color_temp = data.get("colorTemp");
        baseItem.dimmable = data.get("dimmable") === "true";
        baseItem.rechargeable = data.get("rechargeable") === "true";
      }

      await authedSupabase.from("items").insert([baseItem]);
      return Astro.redirect(
        Astro.url.pathname +
          `?toast=created&item=${encodeURIComponent(name || "Utstyr")}`,
      );
    }
  } catch (error: any) {
    console.error("Feil:", error.message);
  }
}

// 3. DATAHENTING
let query = authedSupabase
  .from("items")
  .select("*")
  .eq("household_id", householdId);
if (searchQuery)
  query = query.or(
    `name.ilike.%${searchQuery}%,building.ilike.%${searchQuery}%,department.ilike.%${searchQuery}%,detail.ilike.%${searchQuery}%`,
  );
if (categoryFilter !== "all") query = query.eq("category", categoryFilter);
if (typeFilter) query = query.eq("type", typeFilter);
if (buildingFilter) query = query.eq("building", buildingFilter);

const { data: dbItems } = await query.order("building", { ascending: true });
const { data: dbStock } = await authedSupabase
  .from("stock")
  .select("*")
  .eq("household_id", householdId);

let editItem = editId
  ? (await authedSupabase.from("items").select("*").eq("id", editId).single())
      .data
  : null;

const uniqueTypes = [
  ...new Set((dbItems || []).map((i) => i.type).filter(Boolean)),
];
const uniqueBuildings = [
  ...new Set((dbItems || []).map((i) => i.building).filter(Boolean)),
];

const items: InventoryItem[] = (dbItems || []).map((i) => ({
  id: i.id,
  name: i.name,
  category: i.category,
  type: i.type,
  location: i.location,
  building: i.building,
  department: i.department,
  detail: i.detail,
  requiredCount: i.required_count,
  quantity: i.quantity || 1,
  shape: i.shape,
  colorTemp: i.color_temp,
  dimmable: i.dimmable,
  rechargeable: i.rechargeable,
  lastReplaced: i.last_replaced,
  notes: i.notes,
}));

const stockMap = Object.fromEntries(
  (dbStock || []).map((s) => [
    `${s.type}-${s.shape || ""}-${s.dimmable || false}-${s.rechargeable || false}`,
    s.current_count,
  ]),
);
---

<Layout title="Bytt & Vedlikehold">
  <main class="max-w-md mx-auto px-6 pt-8 pb-32">
    <header class="mb-8">
      <h1 class="text-4xl font-black text-slate-900 tracking-tighter">
        Bytt utstyr
      </h1>
      <p class="text-slate-500 text-sm italic font-medium px-1">
        Oversikt for <strong>{householdName}</strong>
      </p>

      <div class="mt-4 flex justify-end">
        <a
          href={advancedMode
            ? "/enheter?advanced=false"
            : "/enheter?advanced=true"}
          class="text-[10px] font-black uppercase tracking-widest text-slate-400 hover:text-indigo-600 transition-colors bg-slate-50 px-3 py-1.5 rounded-lg border border-slate-100"
        >
          {advancedMode ? "â† Enkel modus" : "âš™ï¸ Avansert modus"}
        </a>
      </div>
    </header>

    <button
      id="openDrawer"
      class="fixed bottom-27 sm:bottom-6 right-6 z-40 bg-gradient-to-br from-indigo-600 to-purple-600 text-white p-5 rounded-full shadow-2xl hover:scale-110 active:scale-95 transition-transform"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="28"
        height="28"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="3"
        stroke-linecap="round"
        stroke-linejoin="round"
        ><path d="M5 12h14"></path><path d="M12 5v14"></path></svg
      >
    </button>

    <div
      id="drawerOverlay"
      class="fixed inset-0 bg-black/50 z-50 opacity-0 pointer-events-none transition-opacity duration-300 backdrop-blur-sm"
    >
    </div>

    <div
      id="drawer"
      class="fixed top-0 right-0 h-full w-full max-w-md bg-slate-50 z-50 shadow-2xl transform translate-x-full transition-transform duration-300 overflow-y-auto rounded-l-[3rem]"
    >
      <div
        class="sticky top-0 bg-slate-900 p-8 z-10 flex justify-between items-center text-white"
      >
        <h2 class="font-black text-xl tracking-tighter">
          {editItem ? "Rediger enhet" : "Registrer ny"}
        </h2>
        <button
          id="closeDrawer"
          class="bg-white/10 p-2 rounded-xl font-black text-xs uppercase tracking-widest"
          >Lukk</button
        >
      </div>

      <div class="p-6 space-y-6">
        {
          editItem ? (
            <div class="bg-white border-2 border-indigo-100 rounded-[2.5rem] p-6 shadow-xl">
              <form method="POST" class="space-y-4">
                <input type="hidden" name="action" value="update_item" />
                <input type="hidden" name="itemId" value={editItem.id} />
                <input
                  type="hidden"
                  name="category"
                  value={editItem.category}
                />

                <div>
                  <label class="block text-[10px] font-black uppercase text-slate-400 mb-1 ml-2">
                    Navn
                  </label>
                  <input
                    type="text"
                    name="name"
                    value={editItem.name}
                    required
                    class="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl px-4 py-3 font-bold outline-none focus:border-indigo-400"
                  />
                </div>

                <div class="grid grid-cols-2 gap-3">
                  <input
                    type="text"
                    name="type"
                    value={editItem.type}
                    placeholder="Type"
                    required
                    class="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl px-4 py-3 font-bold outline-none"
                  />
                  <input
                    type="text"
                    name="shape"
                    value={editItem.shape || ""}
                    placeholder="Form"
                    class="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl px-4 py-3 font-bold outline-none"
                  />
                </div>

                <div class="grid grid-cols-3 gap-3">
                  <input
                    type="text"
                    name="building"
                    value={editItem.building || ""}
                    placeholder="Bygg"
                    class="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl px-4 py-3 font-bold outline-none"
                  />
                  <input
                    type="text"
                    name="department"
                    value={editItem.department || ""}
                    placeholder="Avd"
                    class="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl px-4 py-3 font-bold outline-none"
                  />
                  <input
                    type="text"
                    name="detail"
                    value={editItem.detail || ""}
                    placeholder="Rom"
                    class="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl px-4 py-3 font-bold outline-none"
                  />
                </div>

                <button
                  type="submit"
                  class="w-full bg-indigo-600 text-white font-black py-5 rounded-2xl shadow-lg shadow-indigo-100 uppercase tracking-widest"
                >
                  Lagre endringer
                </button>
              </form>
            </div>
          ) : (
            <div class="space-y-4">
              {/* HER KOMMER DINE TRE REGISTRERINGSKORT (LAMPE, BATTERI, PRINTER) */}
              {/* Du kan beholde dem som de er, men bruk de samme Tailwind-klassene for input-feltene som over */}
              <p class="text-center text-slate-400 text-xs italic">
                Velg type utstyr under for Ã¥ starte registrering.
              </p>
            </div>
          )
        }
      </div>
    </div>

    <div class="mb-8 space-y-3">
      <input
        type="search"
        placeholder="ğŸ” SÃ¸k i utstyr og rom..."
        value={searchQuery}
        class="w-full bg-white border-2 border-slate-100 rounded-[1.5rem] px-6 py-4 text-slate-900 font-bold outline-none focus:border-indigo-400 shadow-sm"
        onchange="updateFilter('search', this.value)"
      />
      <div class="grid grid-cols-2 gap-2">
        <select
          onchange="updateFilter('category', this.value)"
          class="bg-white border-2 border-slate-100 rounded-xl px-4 py-3 font-black text-xs uppercase outline-none"
        >
          <option value="all">ğŸ“¦ Alle typer</option>
          <option value="bulb" selected={categoryFilter === "bulb"}
            >ğŸ’¡ Lamper</option
          >
          <option value="battery" selected={categoryFilter === "battery"}
            >ğŸ”‹ Batterier</option
          >
          <option value="ink" selected={categoryFilter === "ink"}
            >ğŸ–¨ï¸ Printere</option
          >
        </select>
        <select
          onchange="updateFilter('type', this.value)"
          class="bg-white border-2 border-slate-100 rounded-xl px-4 py-3 font-black text-xs uppercase outline-none"
        >
          <option value="">ğŸ·ï¸ Spesifikasjon</option>
          {
            uniqueTypes.map((t) => (
              <option value={t} selected={typeFilter === t}>
                {t}
              </option>
            ))
          }
        </select>
      </div>
    </div>

    <section class="space-y-4">
      <div class="flex items-center justify-between px-2">
        <h2
          class="text-[10px] font-black uppercase tracking-[0.2em] text-slate-300"
        >
          Registrert utstyr
        </h2>
        <span class="text-[10px] font-black text-slate-300"
          >{items.length} ENHETER</span
        >
      </div>

      <div class="grid gap-6">
        {
          items.map((item) => {
            let inStockCount = 0;
            if (item.category === "ink" && item.shape?.includes(",")) {
              const counts = item.shape
                .split(",")
                .map(
                  (c) => stockMap[`${item.type}-${c.trim()}-false-false`] || 0,
                );
              inStockCount = Math.min(...counts);
            } else {
              inStockCount =
                stockMap[
                  `${item.type}-${item.shape || ""}-${item.dimmable || false}-${item.rechargeable || false}`
                ] || 0;
            }
            return (
              <InventoryCard
                {...item}
                inStockCount={inStockCount}
                stockMap={stockMap}
              />
            );
          })
        }
      </div>
    </section>
  </main>
</Layout>

<script>
  import toast from "react-hot-toast";

  // URL Filter logic
  function updateFilter(key: string, value: string) {
    const url = new URL(window.location.href);
    if (value) url.searchParams.set(key, value);
    else url.searchParams.delete(key);
    window.location.href = url.toString();
  }
  
  declare global {
    interface Window {
      updateFilter: (key: string, value: string) => void;
    }
  }
  
  window.updateFilter = updateFilter;

  // Drawer logic
  const drawer = document.getElementById("drawer");
  const overlay = document.getElementById("drawerOverlay");
  const openBtn = document.getElementById("openDrawer");
  const closeBtn = document.getElementById("closeDrawer");

  openBtn?.addEventListener("click", () => {
    drawer?.classList.remove("translate-x-full");
    overlay?.classList.remove("opacity-0", "pointer-events-none");
  });

  const close = () => {
    drawer?.classList.add("translate-x-full");
    overlay?.classList.add("opacity-0", "pointer-events-none");
  };

  closeBtn?.addEventListener("click", close);
  overlay?.addEventListener("click", close);

  // Toast notifications
  const params = new URLSearchParams(window.location.search);
  const toastMsg = params.get("toast");
  const item = params.get("item");
  if (toastMsg && item) {
    const messages: Record<string, string> = {
      created: `âœ… ${item} er nÃ¥ registrert`,
      updated: `âœï¸ ${item} er oppdatert`,
      deleted: `ğŸ—‘ï¸ ${item} er fjernet`,
      replaced: `ğŸ”§ Utstyr byttet pÃ¥ ${item}`,
    };
    toast.success(messages[toastMsg] || "Ferdig!", {
      style: {
        borderRadius: "20px",
        background: "#0f172a",
        color: "#fff",
        fontWeight: "bold",
      },
    });
    window.history.replaceState({}, "", window.location.pathname);
  }
</script>
