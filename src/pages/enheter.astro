---
export const prerender = false;
import Layout from "../layouts/Layout.astro";
import InventoryCard from "../components/InventoryCard.astro";
import { supabase, createAuthenticatedClient } from "../lib/supabase";
import type { InventoryItem, StockItem } from "../types/inventory";

const { householdId } = Astro.locals;

// Lag ein autentisert Supabase-klient for denne requesten
const accessToken = Astro.cookies.get("sb-access-token")?.value;
const authedSupabase = accessToken ? createAuthenticatedClient(accessToken) : supabase;

// Hent husstandstype for √• bestemme default modus
const { data: household } = await authedSupabase
  .from("households")
  .select("type")
  .eq("id", householdId)
  .single();

const householdType = household?.type || "home";

// Hent s√∏k og filter-params
const url = new URL(Astro.request.url);
const searchQuery = url.searchParams.get("search") || "";
const categoryFilter = url.searchParams.get("category") || "all";
const typeFilter = url.searchParams.get("type") || "";
const buildingFilter = url.searchParams.get("building") || "";

// Bestem advancedMode: default basert p√• husstandstype, kan overskrives manuelt
const advancedParam = url.searchParams.get("advanced");
const advancedMode = advancedParam !== null 
  ? advancedParam === "true" 
  : householdType === "facility";

// 1. ACTION H√ÖNDTERING
if (Astro.request.method === "POST") {
  try {
    const data = await Astro.request.formData();
    const action = data.get("action");

    if (action === "replace_item") {
      const itemId = data.get("itemId")?.toString();
      const type = data.get("itemType")?.toString();
      const shape = data.get("itemShape")?.toString() || "";
      const replaceQuantity = Number(data.get("replaceQuantity") || 1);
      const dimmable = data.get("dimmable") === "true";
      const rechargeable = data.get("rechargeable") === "true";

      // Oppdater last_replaced p√• enheten
      await authedSupabase
        .from("items")
        .update({ last_replaced: new Date().toISOString() })
        .eq("id", itemId)
        .eq("household_id", householdId);

      let query = authedSupabase
        .from("stock")
        .select("id, current_count")
        .eq("household_id", householdId)
        .eq("type", type)
        .eq("dimmable", dimmable)
        .eq("rechargeable", rechargeable);

      if (shape && shape !== "null" && shape !== "") {
        query = query.eq("shape", shape);
      } else {
        query = query.or('shape.is.null,shape.eq.""');
      }

      const { data: stock } = await query.single();

      if (stock) {
        await authedSupabase.from("stock")
          .update({ current_count: Math.max(0, (stock.current_count || 0) - replaceQuantity) })
          .eq("id", stock.id);
      }
    }

    else if (action === "create") {
      const category = data.get("category")?.toString();
      
      // Spesialhandtering for printere med fleire patronar
      if (category === "ink") {
        const cartridges = data.getAll("cartridges"); // Array av valde fargar
        const printerName = data.get("name")?.toString();
        const inkType = data.get("type")?.toString().toUpperCase();
        const model = data.get("model")?.toString();
        const building = data.get("building")?.toString();
        const department = data.get("department")?.toString();
        const detail = data.get("detail")?.toString();
        const quantity = Number(data.get("quantity") || 1);
        const notes = data.get("notes")?.toString();
        
        // Opprett ein item per patron
        const itemsToInsert = cartridges.map(cartridge => ({
          name: `${printerName} - ${cartridge}`,
          category: "ink",
          type: inkType,
          shape: cartridge, // Black, Cyan, Magenta, Yellow
          building,
          department,
          detail,
          required_count: 1, // Ein patron per "item"
          quantity,
          color_temp: model, // Lagre modell i color_temp-feltet
          dimmable: false,
          rechargeable: false,
          notes,
          household_id: householdId,
        }));
        
        await authedSupabase.from("items").insert(itemsToInsert);
      } else {
        // Vanleg insert for lamper og batterier
        await authedSupabase.from("items").insert([{
          name: data.get("name"),
          category,
          type: data.get("type")?.toString().toUpperCase(),
          building: data.get("building"),
          department: data.get("department"),
          detail: data.get("detail"),
          required_count: Number(data.get("requiredCount") || 1),
          quantity: Number(data.get("quantity") || 1),
          shape: data.get("shape"),
          color_temp: data.get("colorTemp"),
          dimmable: data.get("dimmable") === "true",
          rechargeable: data.get("rechargeable") === "true",
          notes: data.get("notes"),
          household_id: householdId,
        }]);
      }
    }

    else if (action === "delete") {
      await authedSupabase.from("items")
        .delete()
        .eq("id", data.get("itemId"))
        .eq("household_id", householdId);
    }
  } catch (error: any) {
    console.error("Enhets-feil:", error.message);
  }
}

// 2. DATA QUERY
let query = authedSupabase
  .from("items")
  .select("*")
  .eq("household_id", householdId);

// Filtrer basert p√• s√∏k og filtre
if (searchQuery) {
  query = query.or(`name.ilike.%${searchQuery}%,building.ilike.%${searchQuery}%,department.ilike.%${searchQuery}%,detail.ilike.%${searchQuery}%`);
}
if (categoryFilter !== "all") {
  query = query.eq("category", categoryFilter);
}
if (typeFilter) {
  query = query.eq("type", typeFilter);
}
if (buildingFilter) {
  query = query.eq("building", buildingFilter);
}

const { data: dbItems } = await query.order("building", { ascending: true });

const { data: dbStock } = await authedSupabase
  .from("stock")
  .select("*")
  .eq("household_id", householdId);

// Hent unike verdier for filtre
const uniqueTypes = [...new Set((dbItems || []).map(i => i.type).filter(Boolean))];
const uniqueBuildings = [...new Set((dbItems || []).map(i => i.building).filter(Boolean))];

const items: InventoryItem[] = (dbItems || []).map(i => ({
  id: i.id, 
  name: i.name, 
  category: i.category, 
  type: i.type, 
  location: i.location,
  building: i.building,
  department: i.department,
  detail: i.detail,
  requiredCount: i.required_count, 
  quantity: i.quantity || 1,
  shape: i.shape, 
  colorTemp: i.color_temp,
  dimmable: i.dimmable,
  rechargeable: i.rechargeable,
  lastReplaced: i.last_replaced,
  notes: i.notes
}));

const stockMap = Object.fromEntries(
  (dbStock || []).map(s => [
    `${s.type}-${s.shape || ""}-${s.dimmable || false}-${s.rechargeable || false}`, 
    s.current_count
  ])
);
---

<Layout title="Bytt & Vedlikehold">
  <main class="max-w-md mx-auto px-6 pt-8 pb-32">
    
    <header class="mb-8">
      <h1 class="text-3xl font-black text-slate-900 tracking-tight">Bytt & Vedlikehold</h1>
      <p class="text-slate-500 text-sm italic">Oversikt over alt utstyr i hjemmet.</p>
      
      <div class="mt-4 flex justify-end">
        <a 
          href={advancedMode ? "/enheter?advanced=false" : "/enheter?advanced=true"}
          class="text-xs font-bold text-slate-400 hover:text-blue-600 transition-colors flex items-center gap-1"
        >
          {advancedMode ? "‚Üê Enkel modus" : "‚öôÔ∏è Avansert modus"}
        </a>
      </div>
    </header>

    <div class="grid gap-4 mb-10">
      <!-- LAMPER/LYSP√ÜRER -->
      <details class="group bg-gradient-to-br from-amber-400 to-yellow-500 rounded-[2rem] overflow-hidden">
        <summary class="list-none p-6 flex items-center justify-between cursor-pointer">
          <div class="flex items-center gap-3">
            <div class="bg-white/30 text-white p-2 rounded-xl group-open:rotate-45 transition-transform">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
            </div>
            <span class="font-black uppercase tracking-widest text-xs text-white">üí° Registrer lampe</span>
          </div>
        </summary>
        
        <div class="px-6 pb-6">
          <form method="POST" class="space-y-4">
            <input type="hidden" name="action" value="create" />
            <input type="hidden" name="category" value="bulb" />
            <input type="hidden" name="rechargeable" value="false" />
            
            <div>
              <label class="block text-[9px] font-black uppercase text-amber-900 mb-1 ml-1">Navn p√• lampe</label>
              <input type="text" name="name" placeholder="Taklampe stue" required class="w-full bg-white/90 border border-white/40 rounded-xl px-4 py-3 text-slate-900 font-bold outline-none focus:bg-white" />
            </div>
            
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-[9px] font-black uppercase text-amber-900 mb-1 ml-1">Sokkel (E27, GU10...)</label>
                <input type="text" name="type" placeholder="E27" required class="w-full bg-white/90 border border-white/40 rounded-xl px-4 py-3 text-slate-900 font-bold outline-none focus:bg-white" />
              </div>
              <div>
                <label class="block text-[9px] font-black uppercase text-amber-900 mb-1 ml-1">P√¶reform</label>
                <select name="shape" class="w-full bg-white/90 border border-white/40 rounded-xl px-4 py-3 text-slate-900 font-bold outline-none">
                  <option value="">Standard</option>
                  <option value="Candle">Krone</option>
                  <option value="Globe">Globe</option>
                  <option value="Spot">Spot</option>
                  <option value="Edison">Edison</option>
                </select>
              </div>
            </div>

            {advancedMode ? (
              <>
                <div class="grid grid-cols-3 gap-3">
                  <div>
                    <label class="block text-[9px] font-black uppercase text-amber-900 mb-1 ml-1">Bygning</label>
                    <input type="text" name="building" placeholder="Hovedbygg" class="w-full bg-white/90 border border-white/40 rounded-xl px-4 py-3 text-slate-900 font-bold outline-none" />
                  </div>
                  <div>
                    <label class="block text-[9px] font-black uppercase text-amber-900 mb-1 ml-1">Avdeling</label>
                    <input type="text" name="department" placeholder="Fl√∏y B" class="w-full bg-white/90 border border-white/40 rounded-xl px-4 py-3 text-slate-900 font-bold outline-none" />
                  </div>
                  <div>
                    <label class="block text-[9px] font-black uppercase text-amber-900 mb-1 ml-1">Detalj</label>
                    <input type="text" name="detail" placeholder="2. etasje" class="w-full bg-white/90 border border-white/40 rounded-xl px-4 py-3 text-slate-900 font-bold outline-none" />
                  </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                  <div>
                    <label class="block text-[9px] font-black uppercase text-amber-900 mb-1 ml-1">Antall like enheter</label>
                    <input type="number" name="quantity" value="1" min="1" class="w-full bg-white/90 border border-white/40 rounded-xl px-4 py-3 text-slate-900 font-bold outline-none" />
                  </div>
                  <div>
                    <label class="block text-[9px] font-black uppercase text-amber-900 mb-1 ml-1">P√¶rer per enhet</label>
                    <input type="number" name="requiredCount" value="1" min="1" class="w-full bg-white/90 border border-white/40 rounded-xl px-4 py-3 text-slate-900 font-bold outline-none" />
                  </div>
                </div>
              </>
            ) : (
              <>
                <input type="hidden" name="quantity" value="1" />
                <div class="grid grid-cols-2 gap-3">
                  <div>
                    <label class="block text-[9px] font-black uppercase text-amber-900 mb-1 ml-1">Plassering</label>
                    <input type="text" name="detail" placeholder="Stue" class="w-full bg-white/90 border border-white/40 rounded-xl px-4 py-3 text-slate-900 font-bold outline-none" />
                  </div>
                  <div>
                    <label class="block text-[9px] font-black uppercase text-amber-900 mb-1 ml-1">Antall p√¶rer</label>
                    <input type="number" name="requiredCount" value="1" min="1" class="w-full bg-white/90 border border-white/40 rounded-xl px-4 py-3 text-slate-900 font-bold outline-none" />
                  </div>
                </div>
              </>
            )}

            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-[9px] font-black uppercase text-amber-900 mb-1 ml-1">Lysfarge</label>
                <input type="text" name="colorTemp" placeholder="2700K" class="w-full bg-white/90 border border-white/40 rounded-xl px-4 py-3 text-slate-900 font-bold outline-none" />
              </div>
              <div>
                <label class="block text-[9px] font-black uppercase text-amber-900 mb-1 ml-1">Dimbar?</label>
                <select name="dimmable" class="w-full bg-white/90 border border-white/40 rounded-xl px-4 py-3 text-slate-900 font-bold outline-none">
                  <option value="false">Nei</option>
                  <option value="true">Ja</option>
                </select>
              </div>
            </div>

            <div>
              <label class="block text-[9px] font-black uppercase text-amber-900 mb-1 ml-1">Merknader</label>
              <textarea name="notes" placeholder="Trenger lang stige..." class="w-full bg-white/90 border border-white/40 rounded-xl px-4 py-3 text-slate-900 font-bold outline-none h-20 text-sm"></textarea>
            </div>
            
            <button type="submit" class="w-full bg-white text-amber-600 font-black py-4 rounded-2xl shadow-lg active:scale-[0.98] transition-all">
              REGISTRER LAMPE
            </button>
          </form>
        </div>
      </details>

      <!-- BATTERIDRIVE UTSTYR -->
      <details class="group bg-gradient-to-br from-emerald-500 to-teal-600 rounded-[2rem] overflow-hidden">
        <summary class="list-none p-6 flex items-center justify-between cursor-pointer">
          <div class="flex items-center gap-3">
            <div class="bg-white/30 text-white p-2 rounded-xl group-open:rotate-45 transition-transform">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
            </div>
            <span class="font-black uppercase tracking-widest text-xs text-white">üîã Registrer batteriting</span>
          </div>
        </summary>
        
        <div class="px-6 pb-6">
          <form method="POST" class="space-y-4">
            <input type="hidden" name="action" value="create" />
            <input type="hidden" name="category" value="battery" />
            <input type="hidden" name="shape" value="" />
            <input type="hidden" name="dimmable" value="false" />
            <input type="hidden" name="colorTemp" value="" />
            
            <div>
              <label class="block text-[9px] font-black uppercase text-emerald-900 mb-1 ml-1">Navn p√• utstyr</label>
              <input type="text" name="name" placeholder="Lommelykt, Fjernkontroll..." required class="w-full bg-white/90 border border-white/40 rounded-xl px-4 py-3 text-slate-900 font-bold outline-none focus:bg-white" />
            </div>
            
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-[9px] font-black uppercase text-emerald-900 mb-1 ml-1">Batteritype (AA, AAA...)</label>
                <input type="text" name="type" placeholder="AA" required class="w-full bg-white/90 border border-white/40 rounded-xl px-4 py-3 text-slate-900 font-bold outline-none focus:bg-white" />
              </div>
              <div>
                <label class="block text-[9px] font-black uppercase text-emerald-900 mb-1 ml-1">Antall batteri</label>
                <input type="number" name="requiredCount" value="2" min="1" class="w-full bg-white/90 border border-white/40 rounded-xl px-4 py-3 text-slate-900 font-bold outline-none" />
              </div>
            </div>

            {advancedMode ? (
              <>
                <div class="grid grid-cols-3 gap-3">
                  <div>
                    <label class="block text-[9px] font-black uppercase text-emerald-900 mb-1 ml-1">Bygning</label>
                    <input type="text" name="building" placeholder="Hovedbygg" class="w-full bg-white/90 border border-white/40 rounded-xl px-4 py-3 text-slate-900 font-bold outline-none" />
                  </div>
                  <div>
                    <label class="block text-[9px] font-black uppercase text-emerald-900 mb-1 ml-1">Avdeling</label>
                    <input type="text" name="department" placeholder="Fl√∏y B" class="w-full bg-white/90 border border-white/40 rounded-xl px-4 py-3 text-slate-900 font-bold outline-none" />
                  </div>
                  <div>
                    <label class="block text-[9px] font-black uppercase text-emerald-900 mb-1 ml-1">Detalj</label>
                    <input type="text" name="detail" placeholder="2. etasje" class="w-full bg-white/90 border border-white/40 rounded-xl px-4 py-3 text-slate-900 font-bold outline-none" />
                  </div>
                </div>

                <div class="grid grid-cols-3 gap-3">
                  <div>
                    <label class="block text-[9px] font-black uppercase text-emerald-900 mb-1 ml-1">Antall like enheter</label>
                    <input type="number" name="quantity" value="1" min="1" class="w-full bg-white/90 border border-white/40 rounded-xl px-4 py-3 text-slate-900 font-bold outline-none" />
                  </div>
                  <div>
                    <label class="block text-[9px] font-black uppercase text-emerald-900 mb-1 ml-1">Batteri per enhet</label>
                    <input type="number" name="requiredCount" value="2" min="1" class="w-full bg-white/90 border border-white/40 rounded-xl px-4 py-3 text-slate-900 font-bold outline-none" />
                  </div>
                  <div>
                    <label class="block text-[9px] font-black uppercase text-emerald-900 mb-1 ml-1">Oppladbar?</label>
                    <select name="rechargeable" class="w-full bg-white/90 border border-white/40 rounded-xl px-4 py-3 text-slate-900 font-bold outline-none">
                      <option value="false">Nei</option>
                      <option value="true">Ja</option>
                    </select>
                  </div>
                </div>
              </>
            ) : (
              <>
                <input type="hidden" name="quantity" value="1" />
                <div class="grid grid-cols-3 gap-3">
                  <div>
                    <label class="block text-[9px] font-black uppercase text-emerald-900 mb-1 ml-1">Plassering</label>
                    <input type="text" name="detail" placeholder="Kj√∏kken" class="w-full bg-white/90 border border-white/40 rounded-xl px-4 py-3 text-slate-900 font-bold outline-none" />
                  </div>
                  <div>
                    <label class="block text-[9px] font-black uppercase text-emerald-900 mb-1 ml-1">Antall batteri</label>
                    <input type="number" name="requiredCount" value="2" min="1" class="w-full bg-white/90 border border-white/40 rounded-xl px-4 py-3 text-slate-900 font-bold outline-none" />
                  </div>
                  <div>
                    <label class="block text-[9px] font-black uppercase text-emerald-900 mb-1 ml-1">Oppladbar?</label>
                    <select name="rechargeable" class="w-full bg-white/90 border border-white/40 rounded-xl px-4 py-3 text-slate-900 font-bold outline-none">
                      <option value="false">Nei</option>
                      <option value="true">Ja</option>
                    </select>
                  </div>
                </div>
              </>
            )}

            <div>
              <label class="block text-[9px] font-black uppercase text-emerald-900 mb-1 ml-1">Merknader</label>
              <textarea name="notes" placeholder="Sm√• skruer, trenger skrutrekker..." class="w-full bg-white/90 border border-white/40 rounded-xl px-4 py-3 text-slate-900 font-bold outline-none h-20 text-sm"></textarea>
            </div>
            
            <button type="submit" class="w-full bg-white text-emerald-600 font-black py-4 rounded-2xl shadow-lg active:scale-[0.98] transition-all">
              REGISTRER BATTERITING
            </button>
          </form>
        </div>
      </details>

      <!-- PRINTER -->
      <details class="bg-gradient-to-br from-purple-500 to-indigo-600 p-6 rounded-[2rem] shadow-xl">
        <summary class="flex items-center gap-3 mb-6 cursor-pointer list-none">
          <div class="bg-white/30 p-2 rounded-xl text-white">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><path d="M6 9V3a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v6"/><rect x="6" y="14" width="12" height="8" rx="1"/></svg>
          </div>
          <h2 class="text-white font-black uppercase tracking-widest text-xs">
            üñ®Ô∏è Registrer Printer
          </h2>
        </summary>

        <div>
          <form method="POST" class="space-y-4">
            <input type="hidden" name="action" value="create" />
            <input type="hidden" name="category" value="ink" />
            <input type="hidden" name="requiredCount" value="1" />
            <input type="hidden" name="dimmable" value="false" />
            <input type="hidden" name="rechargeable" value="false" />

            <div>
              <label class="block text-[9px] font-black uppercase text-purple-900 mb-1 ml-1">Navn</label>
              <input type="text" name="name" required placeholder="HP DeskJet i stua" class="w-full bg-white/90 border border-white/40 rounded-xl px-4 py-3 text-slate-900 font-bold outline-none focus:bg-white" />
            </div>

            <div>
              <label class="block text-[9px] font-black uppercase text-purple-900 mb-1 ml-1">Blekk-type</label>
              <input type="text" name="type" required placeholder="HP 302 XL" class="w-full bg-white/90 border border-white/40 rounded-xl px-4 py-3 text-slate-900 font-bold outline-none focus:bg-white" />
            </div>

            <div>
              <label class="block text-[9px] font-black uppercase text-purple-900 mb-2 ml-1">Kva patronar brukar printeren?</label>
              <div class="grid grid-cols-2 gap-3">
                <label class="flex items-center gap-3 bg-white/50 p-3 rounded-xl cursor-pointer">
                  <input type="checkbox" name="cartridges" value="Black" class="w-5 h-5 rounded accent-purple-600" />
                  <span class="text-purple-900 font-bold text-sm">‚¨õ Svart</span>
                </label>
                <label class="flex items-center gap-3 bg-white/50 p-3 rounded-xl cursor-pointer">
                  <input type="checkbox" name="cartridges" value="Cyan" class="w-5 h-5 rounded accent-purple-600" />
                  <span class="text-purple-900 font-bold text-sm">üü¶ Cyan</span>
                </label>
                <label class="flex items-center gap-3 bg-white/50 p-3 rounded-xl cursor-pointer">
                  <input type="checkbox" name="cartridges" value="Magenta" class="w-5 h-5 rounded accent-purple-600" />
                  <span class="text-purple-900 font-bold text-sm">üü™ Magenta</span>
                </label>
                <label class="flex items-center gap-3 bg-white/50 p-3 rounded-xl cursor-pointer">
                  <input type="checkbox" name="cartridges" value="Yellow" class="w-5 h-5 rounded accent-purple-600" />
                  <span class="text-purple-900 font-bold text-sm">üü® Gul</span>
                </label>
              </div>
            </div>

            <div>
              <label class="block text-[9px] font-black uppercase text-purple-900 mb-1 ml-1">Modell (valgfritt)</label>
              <input type="text" name="model" placeholder="DeskJet 3630" class="w-full bg-white/90 border border-white/40 rounded-xl px-4 py-3 text-slate-900 font-bold outline-none" />
            </div>

            {advancedMode ? (
              <>
                <div class="grid grid-cols-3 gap-3">
                  <div>
                    <label class="block text-[9px] font-black uppercase text-purple-900 mb-1 ml-1">Bygning</label>
                    <input type="text" name="building" placeholder="Hovedbygg" class="w-full bg-white/90 border border-white/40 rounded-xl px-4 py-3 text-slate-900 font-bold outline-none" />
                  </div>
                  <div>
                    <label class="block text-[9px] font-black uppercase text-purple-900 mb-1 ml-1">Avdeling</label>
                    <input type="text" name="department" placeholder="2. etasje" class="w-full bg-white/90 border border-white/40 rounded-xl px-4 py-3 text-slate-900 font-bold outline-none" />
                  </div>
                  <div>
                    <label class="block text-[9px] font-black uppercase text-purple-900 mb-1 ml-1">Detalj</label>
                    <input type="text" name="detail" placeholder="Rom 201" class="w-full bg-white/90 border border-white/40 rounded-xl px-4 py-3 text-slate-900 font-bold outline-none" />
                  </div>
                </div>
                <div>
                  <label class="block text-[9px] font-black uppercase text-purple-900 mb-1 ml-1">Antall like enheter</label>
                  <input type="number" name="quantity" value="1" min="1" class="w-full bg-white/90 border border-white/40 rounded-xl px-4 py-3 text-slate-900 font-bold outline-none" />
                </div>
              </>
            ) : (
              <>
                <input type="hidden" name="quantity" value="1" />
                <div>
                  <label class="block text-[9px] font-black uppercase text-purple-900 mb-1 ml-1">Plassering</label>
                  <input type="text" name="detail" placeholder="Kontor" class="w-full bg-white/90 border border-white/40 rounded-xl px-4 py-3 text-slate-900 font-bold outline-none" />
                </div>
              </>
            )}

            <div>
              <label class="block text-[9px] font-black uppercase text-purple-900 mb-1 ml-1">Merknader</label>
              <textarea name="notes" placeholder="Treng b√•de svart og farge..." class="w-full bg-white/90 border border-white/40 rounded-xl px-4 py-3 text-slate-900 font-bold outline-none h-20 text-sm"></textarea>
            </div>
            
            <button type="submit" class="w-full bg-white text-purple-600 font-black py-4 rounded-2xl shadow-lg active:scale-[0.98] transition-all">
              REGISTRER PRINTER
            </button>
          </form>
        </div>
      </details>
    </div>

    <!-- S√òK OG FILTER -->
    <div class="mb-6 space-y-3">
      <div>
        <input 
          type="search" 
          name="search" 
          placeholder={advancedMode ? "üîç S√∏k etter utstyr, bygning, avdeling..." : "üîç S√∏k etter utstyr..."}
          value={searchQuery}
          class="w-full bg-white border-2 border-slate-200 rounded-2xl px-5 py-3 text-slate-900 font-bold outline-none focus:border-blue-400"
          onchange="updateFilter('search', this.value)"
        />
      </div>

      <div class="grid grid-cols-2 gap-3">
        <select 
          name="category" 
          class="bg-white border-2 border-slate-200 rounded-xl px-4 py-2.5 text-slate-900 font-bold text-sm outline-none"
          onchange="updateFilter('category', this.value)"
        >
          <option value="all" selected={categoryFilter === "all"}>üì¶ Alle kategorier</option>
          <option value="bulb" selected={categoryFilter === "bulb"}>üí° Lamper</option>
          <option value="battery" selected={categoryFilter === "battery"}>üîã Batterier</option>
          <option value="ink" selected={categoryFilter === "ink"}>üñ®Ô∏è Printere</option>
        </select>

        <select 
          name="type" 
          class="bg-white border-2 border-slate-200 rounded-xl px-4 py-2.5 text-slate-900 font-bold text-sm outline-none"
          onchange="updateFilter('type', this.value)"
        >
          <option value="">üè∑Ô∏è Alle typer</option>
          {uniqueTypes.map(t => (
            <option value={t} selected={typeFilter === t}>{t}</option>
          ))}
        </select>
      </div>

      {advancedMode && uniqueBuildings.length > 0 && (
        <select 
          name="building" 
          class="w-full bg-white border-2 border-slate-200 rounded-xl px-4 py-2.5 text-slate-900 font-bold text-sm outline-none"
          onchange="updateFilter('building', this.value)"
        >
          <option value="">üè¢ Alle bygninger</option>
          {uniqueBuildings.map(b => (
            <option value={b} selected={buildingFilter === b}>{b}</option>
          ))}
        </select>
      )}

      {(searchQuery || categoryFilter !== "all" || typeFilter || buildingFilter) && (
        <a 
          href="/enheter" 
          class="block text-center text-sm font-bold text-blue-600 py-2"
        >
          ‚úï Nullstill filtre
        </a>
      )}
    </div>

    <section class="space-y-4">
      <div class="flex items-center justify-between px-2">
        <h2 class="text-[10px] font-black uppercase tracking-[0.2em] text-slate-400">Registrert utstyr</h2>
        <span class="text-[10px] font-bold text-slate-400">{items.length} ENHETER</span>
      </div>

      <div class="grid gap-4">
        {items.map(item => (
          <InventoryCard 
            {...item} 
            inStockCount={stockMap[`${item.type}-${item.shape || ""}-${item.dimmable || false}-${item.rechargeable || false}`] || 0} 
          />
        ))}
      </div>
    </section>

  </main>
</Layout>

<script>
  function updateFilter(key: string, value: string) {
    const url = new URL(window.location.href);
    if (value) {
      url.searchParams.set(key, value);
    } else {
      url.searchParams.delete(key);
    }
    window.location.href = url.toString();
  }
  
  // Legg til global funksjon for √• kunne brukes fra inline event handlers
  (window as any).updateFilter = updateFilter;
</script>