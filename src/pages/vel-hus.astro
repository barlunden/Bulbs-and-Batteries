---
export const prerender = false;
import Layout from "../layouts/Layout.astro";
import { supabase, createAuthenticatedClient } from "../lib/supabase";

// Middleware har allerede sjekket auth, s√• vi kan bruke Astro.locals direkte
const user = Astro.locals.user;
if (!user) return Astro.redirect("/login");

const accessToken = Astro.cookies.get("sb-access-token")?.value;
const authedSupabase = accessToken ? createAuthenticatedClient(accessToken) : supabase;

// 1. H√•ndter valg eller oppretting av hus
if (Astro.request.method === "POST") {
  const data = await Astro.request.formData();
  const action = data.get("action");

  if (action === "select") {
    const householdId = data.get("householdId")?.toString();
    if (householdId) {
      Astro.cookies.set("active_household_id", householdId, { path: "/", sameSite: "lax" });
      return Astro.redirect("/dashboard");
    }
  }

  if (action === "create") {
    const name = data.get("name")?.toString();
    const type = data.get("type")?.toString() || "home";
    if (name) {
      // Lag huset (RLS er disabled p√• households)
      const { data: house, error: houseErr } = await authedSupabase
        .from("households")
        .insert([{ name, type }])
        .select()
        .single();

      if (houseErr) {
        console.error("‚ùå Feil ved oppretting av husstand:", houseErr);
        return new Response(`Feil ved oppretting av husstand: ${houseErr.message}`, { status: 500 });
      }

      if (house) {
        // Gj√∏r brukeren til Admin (RLS er disabled p√• household_members)
        const { error: memberErr } = await authedSupabase.from("household_members").insert([{
          household_id: house.id,
          user_id: user.id,
          role: "admin"
        }]);

        if (memberErr) {
          console.error("‚ùå Feil ved oppretting av admin-medlem:", memberErr);
          return new Response(`Feil ved oppretting av admin-medlem: ${memberErr.message}`, { status: 500 });
        }

        Astro.cookies.set("active_household_id", house.id, { path: "/", sameSite: "lax" });
        return Astro.redirect("/dashboard");
      }
    }
  }
}

// 2. Hent medlemskap (hvilke hus har brukaren tilgang til?)
const { data: memberships, error: membershipsError } = await authedSupabase
  .from("household_members")
  .select(`
    role,
    household_id,
    households ( id, name )
  `)
  .eq("user_id", user.id);

if (membershipsError) {
  console.error("‚ùå Feil ved henting av medlemskap:", membershipsError);
}
---

<Layout title="Velg arbeidsplass">
  <main class="max-w-md mx-auto px-6 pt-12 pb-24">
    <header class="mb-10 text-center">
      <h1 class="text-3xl font-black text-slate-900 tracking-tight">Velkommen til Fullt Lager!</h1>
      <p class="text-slate-500 mt-2 italic text-sm text-balance">Velg et sted fra listen, eller opprett en ny oversikt for √• komme i gang.</p>
    </header>

    <section class="space-y-4 mb-12">
      <h2 class="text-[10px] font-black uppercase tracking-[0.2em] text-slate-400 ml-4">Mine steder</h2>
      
      {memberships && memberships.length > 0 ? (
        memberships.map((m: any) => (
          <form method="POST">
            <input type="hidden" name="action" value="select" />
            <input type="hidden" name="householdId" value={m.household_id} />
            <button type="submit" class="w-full text-left p-6 bg-white border-2 border-slate-100 rounded-[2rem] shadow-sm hover:border-indigo-500 hover:shadow-md transition-all group active:scale-[0.98]">
              <div class="flex justify-between items-center">
                <div>
                  <p class="text-[10px] font-black uppercase text-indigo-500 mb-1">{m.role === 'admin' ? '‚≠ê Admin' : 'Medlem'}</p>
                  <h3 class="text-xl font-black text-slate-900">{m.households.name}</h3>
                </div>
                <div class="bg-slate-50 p-3 rounded-2xl group-hover:bg-indigo-600 group-hover:text-white transition-colors">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
                </div>
              </div>
            </button>
          </form>
        ))
      ) : (
        <div class="p-8 border-2 border-dashed border-slate-200 rounded-[2rem] text-center italic text-slate-400 text-sm">
          Du har ikke lagt til eller f√•tt tilgang til noen steder enn√•.
        </div>
      )}
    </section>

    <section class="bg-slate-900 p-8 rounded-[2.5rem] shadow-2xl text-white relative overflow-hidden">
      <div class="absolute top-0 right-0 p-6 opacity-10 rotate-12 pointer-events-none">
        <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path></svg>
      </div>

      <h2 class="text-sm font-black uppercase tracking-widest text-indigo-400 mb-6">Opprett nytt sted</h2>
      
      <form method="POST" class="space-y-4">
        <input type="hidden" name="action" value="create" />
        <div>
          <label class="block text-[10px] font-bold uppercase text-slate-500 mb-2 ml-1">Navn (f.eks. Hjemme, Hytta eller Storgata 12)</label>
          <input 
            type="text" 
            name="name" 
            required 
            class="w-full bg-slate-800 border border-slate-700 rounded-2xl px-5 py-4 text-white outline-none focus:ring-2 focus:ring-indigo-500"
            placeholder="Storgata 12"
          />
        </div>
        
        <div>
          <label class="block text-[10px] font-bold uppercase text-slate-500 mb-2 ml-1">Type</label>
          <div class="grid grid-cols-2 gap-3">
            <label class="relative">
              <input 
                type="radio" 
                name="type" 
                value="home" 
                checked 
                class="peer sr-only"
              />
              <div class="p-4 bg-slate-800 border-2 border-slate-700 rounded-xl cursor-pointer peer-checked:border-indigo-500 peer-checked:bg-indigo-900/30 transition-all">
                <div class="text-2xl mb-1">üè†</div>
                <div class="text-xs font-bold">Privat</div>
                <div class="text-[10px] uppercase font-semibold">Enkel</div>
                <div class="text-[9px] text-slate-400">For deg som vil ha kontroll p√• dingsene hjemme.</div>
              </div>
            </label>
            <label class="relative">
              <input 
                type="radio" 
                name="type" 
                value="facility" 
                class="peer sr-only"
              />
              <div class="p-4 bg-slate-800 border-2 border-slate-700 rounded-xl cursor-pointer peer-checked:border-indigo-500 peer-checked:bg-indigo-900/30 transition-all">
                <div class="text-2xl mb-1">üè¢</div>
                <div class="text-xs font-bold">Vaktmester</div>
                <div class="text-[10px] uppercase font-semibold">Avansert</div>
                <div class="text-[9px] text-slate-400">For deg som administrerer st√∏rre bygg og lager.</div>
              </div>
            </label>
          </div>
        </div>
        <button type="submit" class="w-full bg-indigo-500 hover:bg-indigo-400 text-white font-black py-5 rounded-2xl shadow-lg transition-all active:scale-95 uppercase tracking-widest text-xs">
          Opprett og kom i gang
        </button>
      </form>
    </section>
  </main>
</Layout>