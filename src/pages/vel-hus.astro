---
// [Logikken din forblir helt uendret]
export const prerender = false;
import Layout from "../layouts/Layout.astro";
import { supabase, createAuthenticatedClient } from "../lib/supabase";

const user = Astro.locals.user;
if (!user) return Astro.redirect("/login");

const accessToken = Astro.cookies.get("sb-access-token")?.value;
const authedSupabase = accessToken ? createAuthenticatedClient(accessToken) : supabase;

if (Astro.request.method === "POST") {
  const data = await Astro.request.formData();
  const action = data.get("action");

  if (action === "select") {
    const householdId = data.get("householdId")?.toString();
    if (householdId) {
      Astro.cookies.set("active_household_id", householdId, { path: "/", sameSite: "lax" });
      return Astro.redirect("/dashboard");
    }
  }

  if (action === "create") {
    const name = data.get("name")?.toString();
    const type = data.get("type")?.toString() || "home";
    if (name) {
      const { data: house, error: houseErr } = await authedSupabase
        .from("households")
        .insert([{ name, type }])
        .select()
        .single();

      if (house) {
        await authedSupabase.from("household_members").insert([{
          household_id: house.id,
          user_id: user.id,
          role: "admin"
        }]);
        Astro.cookies.set("active_household_id", house.id, { path: "/", sameSite: "lax" });
        return Astro.redirect("/dashboard");
      }
    }
  }
}

const { data: memberships } = await authedSupabase
  .from("household_members")
  .select(`role, household_id, households ( id, name, type )`)
  .eq("user_id", user.id);
---

<Layout title="Velg sted">
  <main class="max-w-md mx-auto px-6 pt-12 pb-24">
    <header class="mb-10 text-center">
      <div class="inline-block bg-indigo-100 text-indigo-700 text-[10px] font-black px-3 py-1 rounded-full uppercase tracking-widest mb-4">
        Velkommen tilbake
      </div>
      <h1 class="text-4xl font-black text-slate-900 tracking-tighter">Hvor skal du jobbe?</h1>
      <p class="text-slate-500 mt-2 font-medium italic text-sm">Velg et sted eller opprett en ny oversikt.</p>
    </header>

    {/* SEKSJON: MINE STEDER */}
    <section class="space-y-3 mb-12">
      <h2 class="text-[10px] font-black uppercase tracking-[0.2em] text-slate-300 ml-4">Mine lokasjoner</h2>
      
      {memberships && memberships.length > 0 ? (
        memberships.map((m: any) => (
          <form method="POST">
            <input type="hidden" name="action" value="select" />
            <input type="hidden" name="householdId" value={m.household_id} />
            <button type="submit" class="w-full text-left p-6 bg-white border-2 border-slate-100 rounded-[2.5rem] shadow-sm hover:border-indigo-500 hover:shadow-xl hover:shadow-indigo-100 transition-all group active:scale-[0.97]">
              <div class="flex justify-between items-center">
                <div class="flex items-center gap-4">
                  <div class="text-2xl bg-slate-50 w-12 h-12 rounded-2xl flex items-center justify-center group-hover:bg-indigo-50 transition-colors">
                    {m.households.type === 'facility' ? 'üè¢' : 'üè†'}
                  </div>
                  <div>
                    <h3 class="text-lg font-black text-slate-900 leading-tight tracking-tight">{m.households.name}</h3>
                    <p class="text-[9px] font-black uppercase tracking-widest text-indigo-500 mt-1">
                      {m.role === 'admin' ? '‚≠ê Administrator' : 'Medlem'}
                    </p>
                  </div>
                </div>
                <div class="text-slate-300 group-hover:text-indigo-600 transition-colors">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
                </div>
              </div>
            </button>
          </form>
        ))
      ) : (
        <div class="p-10 border-2 border-dashed border-slate-100 rounded-[2.5rem] text-center italic text-slate-400 text-sm bg-slate-50/50">
          Ingen steder registrert enn√•.
        </div>
      )}
    </section>

    {/* SEKSJON: OPPRETT NYTT */}
    <section class="bg-slate-900 p-8 rounded-[3rem] shadow-2xl text-white relative overflow-hidden">
      {/* Dekorativ sirkel i bakgrunnen */}
      <div class="absolute -right-10 -bottom-10 w-40 h-40 bg-indigo-500/10 rounded-full blur-3xl pointer-events-none"></div>

      <div class="flex items-center gap-3 mb-8">
         <div class="w-8 h-8 bg-indigo-500/20 rounded-xl flex items-center justify-center text-indigo-400">
           <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
         </div>
         <h2 class="text-xs font-black uppercase tracking-widest text-white">Opprett ny oversikt</h2>
      </div>
      
      <form method="POST" class="space-y-6 relative z-10">
        <input type="hidden" name="action" value="create" />
        
        <div>
          <label class="block text-[10px] font-black uppercase text-slate-500 mb-2 ml-2 tracking-widest">Hva heter stedet?</label>
          <input 
            type="text" 
            name="name" 
            required 
            placeholder="F.eks. Hjemme eller Lager Vest"
            class="w-full bg-slate-800/50 border-2 border-slate-700 rounded-2xl px-5 py-4 text-white font-bold outline-none focus:border-indigo-500 focus:bg-slate-800 transition-all"
          />
        </div>
        
        <div>
          <label class="block text-[10px] font-black uppercase text-slate-500 mb-2 ml-2 tracking-widest">Velg modus</label>
          <div class="grid grid-cols-2 gap-3">
            <label class="cursor-pointer group">
              <input type="radio" name="type" value="home" checked class="peer sr-only" />
              <div class="h-full p-4 bg-slate-800 border-2 border-slate-700 rounded-2xl peer-checked:border-indigo-500 peer-checked:bg-indigo-500/10 transition-all text-center">
                <div class="text-2xl mb-2 opacity-50 group-hover:opacity-100 transition-opacity">üè†</div>
                <div class="text-[11px] font-black uppercase tracking-tight">Privat</div>
                <div class="text-[9px] text-slate-500 mt-1 font-medium leading-tight">Enkel oversikt for hjemmet</div>
              </div>
            </label>

            <label class="cursor-pointer group">
              <input type="radio" name="type" value="facility" class="peer sr-only" />
              <div class="h-full p-4 bg-slate-800 border-2 border-slate-700 rounded-2xl peer-checked:border-indigo-500 peer-checked:bg-indigo-500/10 transition-all text-center">
                <div class="text-2xl mb-2 opacity-50 group-hover:opacity-100 transition-opacity">üè¢</div>
                <div class="text-[11px] font-black uppercase tracking-tight">Vaktmester</div>
                <div class="text-[9px] text-slate-500 mt-1 font-medium leading-tight">Avansert lager og byggstyring</div>
              </div>
            </label>
          </div>
        </div>

        <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-black py-5 rounded-[1.5rem] shadow-xl shadow-indigo-900/20 transition-all active:scale-95 uppercase tracking-[0.15em] text-xs">
          Start oversikt n√•
        </button>
      </form>
    </section>
  </main>
</Layout>