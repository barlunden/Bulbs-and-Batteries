---
import Layout from "../layouts/Layout.astro";
import { supabase, createAuthenticatedClient } from "../lib/supabase";

const { householdId, user } = Astro.locals;

// Lag ein autentisert Supabase-klient for denne requesten
const accessToken = Astro.cookies.get("sb-access-token")?.value;
const authedSupabase = accessToken
  ? createAuthenticatedClient(accessToken)
  : supabase;

// H√•ndter POST-request for √• oppdatere notat
if (Astro.request.method === "POST") {
  const data = await Astro.request.formData();
  const action = data.get("action");

  if (action === "update_note") {
    const newNote = data.get("global_note")?.toString();
    await authedSupabase
      .from("households")
      .update({ global_note: newNote })
      .eq("id", householdId);

    return Astro.redirect("/");
  }
}

// 1. Hent b√•de navn og det globale notatet for det aktive huset
const { data: household } = await authedSupabase
  .from("households")
  .select("name, global_note")
  .eq("id", householdId)
  .single();

const householdName = household?.name || "Ingen bygg valgt";
const currentGlobalNote =
  household?.global_note || "Ingen merknader for dette bygget.";

// 2. Hent b√•de items og stock for √• sjekke status
const { data: allItems } = await authedSupabase
  .from("items")
  .select("id, type, shape, category, quantity, required_count, dimmable, rechargeable")
  .eq("household_id", householdId);

const { data: stockItems } = await authedSupabase
  .from("stock")
  .select("id, type, shape, current_count, min_threshold, category, dimmable, rechargeable")
  .eq("household_id", householdId);

// Bygg komplett oversikt over kva som manglar
// Inkluderer b√•de eksisterande stock OG items som ikkje har stock enno
const itemsNeedingAttention = [];

// 1. F√∏rst: sjekk alle items og finn ut kva som manglar p√• lager
if (allItems && allItems.length > 0) {
  for (const item of allItems) {
    if (item.category === "ink") {
      // Spesialhandtering for printere
      const cartridges = (item.shape || "").split(",").map(c => c.trim()).filter(c => c.length > 0);
      for (const cartridge of cartridges) {
        const stockEntry = stockItems?.find(s => 
          s.type === item.type && 
          s.shape === cartridge && 
          s.category === "ink"
        );
        
        const currentCount = stockEntry?.current_count ?? 0;
        const threshold = stockEntry?.min_threshold ?? item.quantity;
        
        if (currentCount <= threshold) {
          itemsNeedingAttention.push({
            type: `${item.type} ${cartridge}`,
            count: currentCount,
            threshold
          });
        }
      }
    } else {
      // Lamper og batterier
      const stockEntry = stockItems?.find(s => 
        s.type === item.type &&
        (s.shape || "") === (item.shape || "") &&
        s.dimmable === item.dimmable &&
        s.rechargeable === item.rechargeable &&
        s.category === item.category
      );
      
      const totalNeeded = (item.quantity || 1) * (item.required_count || 1);
      const currentCount = stockEntry?.current_count ?? 0;
      const threshold = stockEntry?.min_threshold ?? totalNeeded;
      
      if (currentCount <= threshold) {
        const displayName = item.shape && item.shape !== "null" && item.shape !== ""
          ? `${item.type} ${item.shape}`
          : item.type;
        
        itemsNeedingAttention.push({
          type: displayName,
          count: currentCount,
          threshold
        });
      }
    }
  }
}

const hasData = allItems && allItems.length > 0;
const itemsLow = itemsNeedingAttention;
const allOk = hasData && itemsLow.length === 0;
---

<Layout title="Heim">
  <main class="max-w-md mx-auto px-6 pt-12 pb-32">
    <header class="mb-10 relative">
      <div class="flex items-center gap-2 mb-1">
        <span class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span>
        <span
          class="text-[10px] font-black uppercase tracking-widest text-slate-400"
          >Valgt sted</span
        >
      </div>
      <h1
        class="text-4xl font-black text-slate-900 tracking-tight leading-none mb-2"
      >
        {householdName}
      </h1>

      <div
        class="mt-4 p-4 bg-gradient-to-br from-yellow-50 to-amber-50 rounded-2xl border border-yellow-200/50"
      >
        <div class="text-sm text-slate-700 leading-relaxed">
          {
            !hasData ? (
              <>
                <p class="font-bold text-amber-700 mb-2">üí° Tips</p>
                <p>
                  Registrer lampene og dingsene dine √©n gang, s√• holder vi
                  kontroll p√• sokler og batterityper for deg.
                </p>
              </>
            ) : allOk ? (
              <>
                <p class="font-bold text-emerald-700 mb-2">
                  ‚úÖ Lagerstatus for {householdName}
                </p>
                <p>Alt ok! Du har nok av alt p√• lager.</p>
              </>
            ) : (
              <>
                <p class="font-bold text-amber-700 mb-2">
                  ‚ö†Ô∏è Lagerstatus for {householdName}
                </p>
                <p class="mb-2">Du mangler:</p>
                <ul class="list-disc list-inside space-y-1">
                  {itemsLow.map((item) => (
                    <li class="font-medium text-amber-800">{item.type}</li>
                  ))}
                </ul>
              </>
            )
          }
        </div>
      </div>
    </header>

    <section
      class="bg-amber-100 border-2 border-amber-200 p-6 rounded-[2.5rem] mb-10 shadow-sm relative group"
    >
      <div class="absolute top-4 right-6 opacity-20">
        <svg
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="3"
          ><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"
          ></path><path
            d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"
          ></path></svg
        >
      </div>
      <h2
        class="text-[10px] font-black uppercase tracking-widest text-amber-700 mb-2 italic"
      >
        ‚ö†Ô∏è Huskelapp for {householdName}
      </h2>

      <details class="group/edit">
        <summary class="list-none cursor-pointer">
          <p
            class="text-amber-900 font-medium leading-relaxed italic text-sm mb-3"
          >
            "{currentGlobalNote}"
          </p>
          <button
            type="button"
            class="text-[9px] font-black uppercase text-amber-700/50 hover:text-amber-700 transition-colors"
          >
            Endre notat
          </button>
        </summary>

        <form method="POST" class="mt-4 space-y-3">
          <input type="hidden" name="action" value="update_note" />
          <textarea
            name="global_note"
            class="w-full bg-white border-2 border-amber-300 rounded-xl px-4 py-3 text-amber-900 font-medium outline-none focus:border-amber-500 resize-none"
            rows="3"
            placeholder="Skriv inn huskelapp...">{currentGlobalNote}</textarea
          >
          <div class="flex gap-2">
            <button
              type="submit"
              class="flex-1 bg-amber-600 hover:bg-amber-500 text-white font-black py-2 rounded-xl text-xs uppercase transition-colors"
            >
              Lagre
            </button>
            <button
              type="button"
              onclick="this.closest('details').removeAttribute('open')"
              class="px-4 bg-white border-2 border-amber-300 text-amber-700 font-bold rounded-xl text-xs transition-colors hover:bg-amber-50"
            >
              Avbryt
            </button>
          </div>
        </form>
      </details>
    </section>

    <section
      class="bg-gradient-to-br from-indigo-50 to-purple-50 border-2 border-indigo-200 p-6 rounded-[2.5rem] mb-10 shadow-sm"
    >
      <h2
        class="text-[10px] font-black uppercase tracking-widest text-indigo-700 mb-3 flex items-center gap-2"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="14"
          height="14"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="3"
          stroke-linecap="round"
          stroke-linejoin="round"
          ><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle
            cx="9"
            cy="7"
            r="4"></circle><path d="M22 21v-2a4 4 0 0 0-3-3.87"></path><path
            d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg
        >
        Din e-post
      </h2>
      <div class="bg-white/80 rounded-xl p-4 mb-2 border border-indigo-100">
        <p class="text-sm font-bold text-slate-800">{user?.email}</p>
      </div>
      <p class="text-[9px] text-indigo-800 italic">
        Del denne e-posten med administrator for √• f√• tilgang til flere
        husstander
      </p>
    </section>

    <nav class="grid gap-4">
      <a
        href="/enheter"
        class="group bg-indigo-600 p-8 rounded-[2rem] flex items-center justify-between text-white shadow-xl shadow-indigo-100 active:scale-95 transition-all"
      >
        <div class="flex flex-col">
          <span class="text-2xl font-black">Bytt p√¶re/batteri</span>
          <span class="text-indigo-200 text-sm font-medium"
            >Se alle lamper og utstyr</span
          >
        </div>
        <div
          class="bg-white/20 p-4 rounded-2xl group-hover:translate-x-1 transition-transform"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="32"
            height="32"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="3"
            stroke-linecap="round"
            stroke-linejoin="round"><path d="m9 18 6-6-6-6"></path></svg
          >
        </div>
      </a>

      <a
        href="/beholdning"
        class="group bg-slate-900 p-8 rounded-[2rem] flex items-center justify-between text-white shadow-xl shadow-slate-100 active:scale-95 transition-all"
      >
        <div class="flex flex-col">
          <span class="text-2xl font-black">Innkj√∏p</span>
          <span class="text-slate-400 text-sm font-medium"
            >Oppdater lageret</span
          >
        </div>
        <div
          class="bg-white/10 p-4 rounded-2xl group-hover:translate-x-1 transition-transform"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="32"
            height="32"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="3"
            stroke-linecap="round"
            stroke-linejoin="round"><path d="m9 18 6-6-6-6"></path></svg
          >
        </div>
      </a>
    </nav>
  </main>
</Layout>
