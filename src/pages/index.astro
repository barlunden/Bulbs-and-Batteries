---
import Layout from "../layouts/Layout.astro";
import { supabase, createAuthenticatedClient } from "../lib/supabase";

const { householdId, user } = Astro.locals;

// Lag ein autentisert Supabase-klient for denne requesten
const accessToken = Astro.cookies.get("sb-access-token")?.value;
const authedSupabase = accessToken ? createAuthenticatedClient(accessToken) : supabase;

// 1. Hent både navn og det globale notatet for det aktive huset
const { data: household } = await authedSupabase
  .from("households")
  .select("name, global_note")
  .eq("id", householdId)
  .single();

const householdName = household?.name || "Ingen bygg valgt";
const currentGlobalNote = household?.global_note || "Ingen merknader for dette bygget.";
---

<Layout title="Heim">
  <main class="max-w-md mx-auto px-6 pt-12 pb-32">
    <header class="mb-10 relative">
      <a href="/vel-hus" class="absolute -top-6 right-0 text-[10px] font-black uppercase text-indigo-600 bg-white border border-slate-200 px-4 py-2 rounded-full shadow-sm active:scale-95 transition-all">
        Bytt bygg ⇄
      </a>
      
      <div class="flex items-center gap-2 mb-1">
        <span class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span>
        <span class="text-[10px] font-black uppercase tracking-widest text-slate-400">Du jobber nå på</span>
      </div>
      <h1 class="text-4xl font-black text-slate-900 tracking-tight leading-none mb-2">{householdName}</h1>
    </header>

    <section class="bg-amber-100 border-2 border-amber-200 p-6 rounded-[2.5rem] mb-10 shadow-sm relative group">
      <div class="absolute top-4 right-6 opacity-20">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
      </div>
      <h2 class="text-[10px] font-black uppercase tracking-widest text-amber-700 mb-2 italic">⚠️ Husk på dette her</h2>
      <p class="text-amber-900 font-medium leading-relaxed italic text-sm">
        "{currentGlobalNote}"
      </p>
      
      <button class="mt-4 text-[9px] font-black uppercase text-amber-700/50 hover:text-amber-700 transition-colors">
        Endre notat
      </button>
    </section>

    <section class="bg-gradient-to-br from-indigo-50 to-purple-50 border-2 border-indigo-200 p-6 rounded-[2.5rem] mb-10 shadow-sm">
      <h2 class="text-[10px] font-black uppercase tracking-widest text-indigo-700 mb-3 flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
        Din e-post
      </h2>
      <div class="bg-white/80 rounded-xl p-4 mb-2 border border-indigo-100">
        <p class="text-sm font-bold text-slate-800">{user?.email}</p>
      </div>
      <p class="text-[9px] text-indigo-800 italic">
        Del denne e-posten med administrator for å få tilgang til flere husstander
      </p>
    </section>

    <nav class="grid gap-4">
      <a href="/enheter" class="group bg-indigo-600 p-8 rounded-[2rem] flex items-center justify-between text-white shadow-xl shadow-indigo-100 active:scale-95 transition-all">
        <div class="flex flex-col">
          <span class="text-2xl font-black">Bytt pære</span>
          <span class="text-indigo-200 text-sm font-medium">Sjå alle lamper og utstyr</span>
        </div>
        <div class="bg-white/20 p-4 rounded-2xl group-hover:translate-x-1 transition-transform">
          <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
        </div>
      </a>

      <a href="/beholdning" class="group bg-slate-900 p-8 rounded-[2rem] flex items-center justify-between text-white shadow-xl shadow-slate-100 active:scale-95 transition-all">
        <div class="flex flex-col">
          <span class="text-2xl font-black">Innkjøp</span>
          <span class="text-slate-400 text-sm font-medium">Oppdater lageret</span>
        </div>
        <div class="bg-white/10 p-4 rounded-2xl group-hover:translate-x-1 transition-transform">
          <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
        </div>
      </a>
    </nav>
  </main>
</Layout>